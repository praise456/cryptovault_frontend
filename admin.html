<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --primary: #00c853; /* bright green */
      --primary-dark: #009624;
      --bg: #f4f4f4;
      --text: #222;
      --border: #ccc;
      --black: #000;
      --radius: 6px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    header {
      background-color: var(--black);
      color: var(--primary);
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    header h2 {
      margin: 0;
      font-size: 1.8rem;
    }

    header p {
      margin: 4px 0 0;
      font-size: 1rem;
      color: #bbb;
    }

    main {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }

    h3 {
      margin-top: 0;
      color: var(--black);
      border-left: 4px solid var(--primary);
      padding-left: 8px;
    }

    button {
      background-color: var(--primary);
      border: none;
      color: var(--black);
      font-weight: bold;
      padding: 8px 14px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    button:hover {
      background-color: var(--primary-dark);
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background-color: var(--black);
      color: var(--primary);
      font-weight: 600;
    }

    tr:hover td {
      background-color: #e8f5e9;
    }

    input[type="number"] {
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      width: 80px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
    }

    .status-btn {
      background-color: var(--primary);
      margin-left: 6px;
    }

    .status-btn:hover {
      background-color: var(--primary-dark);
      color: white;
    }

    .danger {
      background-color: red;
      color: white;
    }

    .danger:hover {
      background-color: darkred;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 10px;
        background: white;
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }

      td:last-child {
        border-bottom: none;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        display: block;
        color: var(--primary-dark);
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>Admin Dashboard</h2>
    <p>Welcome, Admin</p>
  </header>

  <main>
    <h3>All Users</h3>
    <button id="loadUsersBtn">Load Users</button>
    <table id="userTable" aria-live="polite">
      <thead>
        <tr>
          <th>Email</th>
          <th>Balance</th>
          <th>Investments</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3>Pending Withdrawals</h3>
<button onclick="loadWithdrawals()">Load Withdrawals</button>
<table border="1" id="adminWithdrawTable">
  <thead><tr><th>User</th><th>Coin</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
  <tbody></tbody>
</table>

  </main>

  <script>
    const API_BASE = 'https://crypto-backend-t3bz.onrender.com';

    function joinUrl(base, path) {
      return base.replace(/\/+$/, '') + '/' + path.replace(/^\/+/, '');
    }

    function authHeaders(token) {
      return { 'Content-Type': 'application/json', 'x-auth-token': token };
    }

    async function fetchJson(url, options = {}) {
      try {
        const res = await fetch(url, options);
        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (e) { data = { msg: text }; }
        if (!res.ok) {
          const msg = data.msg || data.error || `Request failed (${res.status})`;
          const err = new Error(msg);
          err.status = res.status;
          err.body = data;
          throw err;
        }
        return data;
      } catch (err) {
        console.error('fetchJson error:', err);
        throw err;
      }
    }

    async function fetchUsers() {
      const token = localStorage.getItem('token');
      if (!token) return alert('No auth token found. Please login.');

      const url = joinUrl(API_BASE, '/api/admin/users');
      try {
        const data = await fetchJson(url, { headers: authHeaders(token) });
        renderUserTable(data.users || []);
      } catch (err) {
        alert(err.message || 'Failed to load users');
      }
    }

    function renderUserTable(users) {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      users.forEach((u) => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td data-label="Email">${u.email || '(no email)'}</td>
          <td data-label="Balance">$${(u.balance || 0).toFixed ? u.balance.toFixed(2) : (u.balance || 0)}</td>
          <td data-label="Investments" class="small">
            ${Array.isArray(u.investments) && u.investments.length
              ? u.investments.map((inv, i) => `
                  <div>
                    <strong>[${i}] ${inv.plan || '—'}</strong>
                    — $${inv.amount || 0} @ ${inv.rate || 0}% — ${inv.status || 'n/a'}
                    <button class="status-btn" data-action="complete" data-user="${u._id}" data-index="${i}">Complete</button>
                  </div>
                `).join('')
              : 'No investments'}
          </td>
          <td data-label="Actions">
            <input type="number" step="0.01" min="0" placeholder="Amount" data-amt-for="${u._id}" />
            <button data-action="credit" data-user="${u._id}">Credit</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.querySelector('#userTable tbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.getAttribute('data-action');
      const userId = btn.getAttribute('data-user');

      if (action === 'credit') {
        const input = document.querySelector(`input[data-amt-for="${userId}"]`);
        const amount = parseFloat(input.value);
        if (isNaN(amount) || amount <= 0) return alert('Enter a valid amount to credit');
        await creditUser(userId, amount);
      } else if (action === 'complete') {
        const invIndex = parseInt(btn.getAttribute('data-index'), 10);
        if (Number.isNaN(invIndex)) return alert('Bad investment index');
        await updateStatus(userId, invIndex, 'completed');
      }
    });

    async function creditUser(userId, amount) {
      const token = localStorage.getItem('token');
      if (!token) return alert('Not authenticated');

      const url = joinUrl(API_BASE, '/api/admin/credit');
      try {
        const body = { userId, amount };
        const data = await fetchJson(url, {
          method: 'POST',
          headers: authHeaders(token),
          body: JSON.stringify(body),
        });
        alert(data.msg || 'Credited successfully');
        fetchUsers();
      } catch (err) {
        alert(err.message || 'Credit failed');
      }
    }

    async function updateStatus(userId, investIndex, newStatus) {
      const token = localStorage.getItem('token');
      if (!token) return alert('Not authenticated');

      const url = joinUrl(API_BASE, '/api/admin/status');
      try {
        const body = { userId, investIndex, newStatus };
        const data = await fetchJson(url, {
          method: 'POST',
          headers: authHeaders(token),
          body: JSON.stringify(body),
        });
        alert(data.msg || 'Status updated');
        fetchUsers();
      } catch (err) {
        alert(err.message || 'Status update failed');
      }
    }

    document.getElementById('loadUsersBtn').addEventListener('click', fetchUsers);

    window.addEventListener('load', () => {
      if (localStorage.getItem('token')) fetchUsers();
    });

    async function loadWithdrawals() {
  const token = localStorage.getItem("token");
  const res = await fetch("https://crypto-backend-t3bz.onrender.com/api/admin/withdrawals", {
    headers: { "x-auth-token": token }
  });
  const data = await res.json();
  let rows = "";
  data.users.forEach(user => {
    (user.withdrawals || []).forEach((w, idx) => {
      rows += `
        <tr>
          <td>${user.email}</td>
          <td>${w.coin}</td>
          <td>${w.amount}</td>
          <td>${w.status}</td>
          <td>
            ${w.status === 'pending' ? `
              <button onclick="updateWithdrawal('${user._id}', ${idx}, 'approved')">Approve</button>
              <button onclick="updateWithdrawal('${user._id}', ${idx}, 'rejected')">Reject</button>
            ` : ''}
          </td>
        </tr>
      `;
    });
  });
  document.querySelector("#adminWithdrawTable tbody").innerHTML = rows;
}

async function updateWithdrawal(userId, index, status) {
  const token = localStorage.getItem("token");
  const res = await fetch("https://crypto-backend-t3bz.onrender.com/api/admin/withdrawals/update", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-auth-token": token },
    body: JSON.stringify({ userId, index, status })
  });
  const data = await res.json();
  alert(data.msg);
  loadWithdrawals();
}
  </script>
</body>
</html>

